"""Defines an Abstract Processor class that processor raw data to generate QA datasets.

It also contains a processor registry that contains a set of registered processor.
"""

from __future__ import annotations

import os
from abc import abstractmethod
from typing import TYPE_CHECKING

from rago.dataset.base import QADataset
from rago.utils import PATH_DEFAULT_DATA_DIR

if TYPE_CHECKING:
    from collections.abc import Callable

DEFAULT_CACHE_DIR = str(os.environ.get("DEFAULT_CACHE_DIR", PATH_DEFAULT_DATA_DIR))

PROCESSOR_REGISTRY: dict[str, type[DataProcessor]] = {}


def register_processor(name: str) -> Callable[[type[DataProcessor]], type[DataProcessor]]:
    """Register a data processor.

    :param name: Processor name.
    :type name: str
    :return: Decorator function.
    :rtype: Callable
    """

    def decorator(cls: type[DataProcessor]) -> type[DataProcessor]:
        PROCESSOR_REGISTRY[name] = cls
        return cls

    return decorator


class UnRegisteredProcessorError(ValueError):
    """Exception raised when attempting to access a processor that is not registered.

    This error is typically thrown when a dataset name is provided for which
    no corresponding processor has been registered in the processor registry.
    """

    def __init__(self, name: str) -> None:
        """Initialize the error with the name of the dataset whose processor is missing.

        :param name: The dataset name for which no processor was found in the registry.
        :type name: str
        """
        super().__init__(f"There is no processor registered for dataset {name}.")


class DataProcessor[DatasetType: QADataset, RawDataType]:
    """Abstract base class for dataset processors.

    :param name: Dataset name.
    :type name: str
    :param path_dataset: Path to raw dataset files.
    :type path_dataset: str
    """

    def __init__(self, name: str, path_dataset: str) -> None:
        """Instantiate a processor from its name and the path to which the dataset should be save.

        :param name: Name of the processor.
        :type name: str
        :param path_dataset: Path where the dataset generated by the processor should be stored.
        :type path_dataset: str
        """
        self.name = name
        self.path_dataset = path_dataset

    def get_processed_dataset(self) -> DatasetType | dict[str, DatasetType]:
        """Process raw dataset into structured format.

        :return: Processed dataset or split dictionary.
        :rtype: DatasetType | dict[str, DatasetType]
        """
        raw_data = self.download_raw_data()
        return self.process_raw_data(raw_data)

    @abstractmethod
    def download_raw_data(self) -> RawDataType:
        """Download raw dataset.

        :return: Raw dataset content.
        :rtype: RawDataType
        """

    @abstractmethod
    def process_raw_data(
        self,
        raw_data: RawDataType,
    ) -> DatasetType | dict[str, DatasetType]:
        """Transform raw dataset into structured format.

        :param raw_data: Raw dataset content.
        :type raw_data: RawDataType
        :return: Processed dataset or split dictionary.
        :rtype: DatasetType | dict[str, DatasetType]
        """

    @classmethod
    def get_data_processor(
        cls,
        name: str,
        path_dataset: str,
    ) -> DataProcessor[DatasetType, RawDataType]:
        """Get the data processor from the processor registry based on its name.

        :param name: Name of the processor to retrieve from the registry.
        :type name: str
        :param path_dataset: Path of the dataset the processor must create.
        :type path_dataset: str
        :raises ValueError: If the processor is not in the registry.
        :return: The corresponding processor.
        :rtype: DataProcessor[DatasetType, RawDataType]
        """
        if name in PROCESSOR_REGISTRY:
            return PROCESSOR_REGISTRY[name](name=name, path_dataset=path_dataset)
        raise UnRegisteredProcessorError(name)
